# dynamic/path.yml
http:
  routers:
    r-frontend:
      entryPoints: [web]
      rule: PathPrefix(`/`)
      service: s-frontend
      priority: 1

    r-auth:
      entryPoints: [web]
      rule: PathPrefix(`/auth`)
      service: s-auth
      middlewares: [cors]
      priority: 10

    r-users:
      entryPoints: [web]
      rule: PathPrefix(`/api/users`)
      service: s-users
      middlewares: [cors, mw-auth-forward, mw-users-replace]  # see note below about order
      priority: 20

    r-devices:
      entryPoints: [web]
      rule: PathPrefix(`/api/devices`)
      service: s-devices
      middlewares: [cors, mw-auth-forward, mw-devices-replace]  # see note below about order
      priority: 20

    r-monitoring:
      entryPoints: [web]
      rule: PathPrefix(`/api/monitoring`)
      service: s-monitoring
      middlewares: [cors, mw-auth-forward]
      priority: 20

    # Handle CORS preflights (no auth, no backend)
    r-preflight:
      entryPoints: [web]
      rule: "Method(`OPTIONS`) && PathPrefix(`/api`)"
      service: noop@internal
      middlewares: [cors]
      priority: 30

  middlewares:
    cors:
      headers:
        accessControlAllowOriginList:
          - "http://localhost:3000"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "PATCH"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
        accessControlAllowCredentials: true
        addVaryHeader: true

    mw-auth-forward:
      forwardAuth:
        address: "http://auth-service:8082/auth/validate"
        authRequestHeaders:
          - "Authorization"      # send the bearer token to auth
        authResponseHeaders:      # <-- copy these headers from /auth/validate back onto the original request
          - "H-User-Id"
          - "H-User-Role"
          - "H-User-Email"
        trustForwardHeader: true  # ok to keep true/false; not required, but harmless

    mw-users-replace:
      replacePathRegex:
        regex: ^/api/users(.*)
        replacement: /people$1

    mw-devices-replace:
      replacePathRegex:
        regex: ^/api/devices(.*)
        replacement: /devices$1

  services:
    s-frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"
    s-auth:
      loadBalancer:
        servers:
          - url: "http://auth-service:8082"
    s-users:
      loadBalancer:
        servers:
          - url: "http://spring-demo:8080"
    s-devices:
      loadBalancer:
        servers:
          - url: "http://device-service:8081"
    s-monitoring:
      loadBalancer:
        servers:
          - url: "http://monitoring-service:8083"
